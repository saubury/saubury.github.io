<!DOCTYPE html>
<html lang="en-au" dir="ltr">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Using KSQL, Apache Kafka, a Raspberry Pi and a software defined radio to find the plane that wakes Snowy the cat &middot; Simon Aubury</title>
  <meta name="description" content="Map the correlation between aircraft traffic and cat behaviour" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://simonaubury.com/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://simonaubury.com/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://simonaubury.com/favicon-16x16.png">
  <link href="https://simonaubury.com/css/katex.min.css" rel="stylesheet">
  
  
  
  
  <link href="https://simonaubury.com/css/concated.min.css" rel="stylesheet">
  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7N67PMRZ6N"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-7N67PMRZ6N', { 'anonymize_ip': false });
}
</script>

  
</head>

  <body class="single-body">
    <nav class="nav-bar side-padding">
  <h1 class="nav-header"><a href="https://simonaubury.com/" class="nav-text">simon aubury</a></h1>
  <div class="hamburger-menu">
    <input class="hamburger-menu-button" type="checkbox"
      onclick="hamburgerMenuPressed.call(this)"
      aria-label="Hamburger Menu Button"
    >
    <div class="hamburger-menu-icon">
      <span></span>
      <span></span>
    </div>
    <ul id="menu" class="hamburger-menu-overlay">
      <li><a href="https://simonaubury.com/" class="hamburger-menu-overlay-link">Home</a></li>
      <li><a href="https://simonaubury.com/slides/" class="hamburger-menu-overlay-link">Presentation slides</a></li>
      <li><a href="https://simonaubury.com/about-me/" class="hamburger-menu-overlay-link">About Simon</a></li>
      
      <li><a href="https://simonaubury.com/categories/cat/" class="hamburger-menu-overlay-link">Cat</a></li>
      
      <li><a href="https://simonaubury.com/categories/cdc/" class="hamburger-menu-overlay-link">CDC</a></li>
      
      <li><a href="https://simonaubury.com/categories/duckdb/" class="hamburger-menu-overlay-link">duckdb</a></li>
      
      <li><a href="https://simonaubury.com/categories/flink/" class="hamburger-menu-overlay-link">flink</a></li>
      
      <li><a href="https://simonaubury.com/categories/generativeai/" class="hamburger-menu-overlay-link">GenerativeAI</a></li>
      
      <li><a href="https://simonaubury.com/categories/gpt/" class="hamburger-menu-overlay-link">GPT</a></li>
      
      <li><a href="https://simonaubury.com/categories/homeassistant/" class="hamburger-menu-overlay-link">homeassistant</a></li>
      
      <li><a href="https://simonaubury.com/categories/kafka/" class="hamburger-menu-overlay-link">Kafka</a></li>
      
      <li><a href="https://simonaubury.com/categories/ml/" class="hamburger-menu-overlay-link">ML</a></li>
      
      <li><a href="https://simonaubury.com/categories/raspberry-pi/" class="hamburger-menu-overlay-link">Raspberry Pi</a></li>
      
      <li><a href="https://simonaubury.com/categories/snowflake/" class="hamburger-menu-overlay-link">snowflake</a></li>
      
      <li><a href="https://simonaubury.com/index.xml" class="hamburger-menu-overlay-link">rss</a></li>
    </ul>
  </div>
</nav>

    <main class="content side-text-padding">
      <article class="post dropcase">
        <header class="post-header">
          <h1 class="post-title">Using KSQL, Apache Kafka, a Raspberry Pi and a software defined radio to find the plane that wakes Snowy the cat</h1>
          <p class="post-date">Posted <time datetime="2018-05-20">May 20, 2018</time></p>
        </header>
        <picture class="post-figure">
          
          
          
          <source srcset="https://simonaubury.com/posts/201805_usingksqlapachekafkafindtheplanethatwakessnowy/00000003_hu5a63df5c04a385efaa6300a478a8b844_637285_711x0_resize_lanczos_1.gif 1x, https://simonaubury.com/posts/201805_usingksqlapachekafkafindtheplanethatwakessnowy/00000003_hu5a63df5c04a385efaa6300a478a8b844_637285_1422x0_resize_lanczos_1.gif 2x, https://simonaubury.com/posts/201805_usingksqlapachekafkafindtheplanethatwakessnowy/00000003_hu5a63df5c04a385efaa6300a478a8b844_637285_2133x0_resize_lanczos_1.gif 3x">
          <img src="https://simonaubury.com/posts/201805_usingksqlapachekafkafindtheplanethatwakessnowy/00000003_hu5a63df5c04a385efaa6300a478a8b844_637285_711x0_resize_lanczos_1.gif" >
        </picture>
        
        
        <h1 id="using-ksql-apache-kafka-a-raspberry-pi-and-a-software-defined-radio-to-find-the-plane-that-wakes-snowy-the-cat">Using KSQL, Apache Kafka, a Raspberry Pi and a software defined radio to find the plane that wakes Snowy the cat</h1>
<p>Using open-source streaming solutions to map the correlation between aircraft traffic and cat behaviour</p>
<p>Aircraft determine their position using GPS; and periodically transmit that position along with identity string, altitude, speed etc as ADS-B signals.</p>
<p>Cats behave erratically, but generally display their displeasure by jumping on your face. The post describes how we can use open source streaming solutions (Apache Kafka), KSQL (streaming SQL engine) and a Raspberry Pi to process aircraft movements in real-time to determine which plane is upsetting my cat.</p>
<h2 id="overview">Overview</h2>
<p><img src="00000000.png" alt="Planes to graphs using Kafka &amp; KSQL"><em>Planes to graphs using Kafka &amp; KSQL</em></p>
<p>I built a receiver to listen to aircraft transponder messages (ADS-B signals) as the planes fly overhead. These aircraft transmissions are not coordinated — the messages appear as a jumble of interwoven transmissions. Specifically I wanted to capture the <em>location</em> and <em>callsign</em> transmissions.</p>
<p>But unravelling these mixed streams is complex — it’s like trying to understand a conversation when everyone’s talking at the same time at a party. I decided to use a combination of Kafka and KSQL to find the plane that freaks out my cat.</p>
<h2 id="ads-b-capture-using-a-raspberry-pi">ADS-B capture using a Raspberry Pi</h2>
<p>To capture the aircraft transmissions I used a Raspberry Pi and a RTL2832U — a USB dongle originally sold to watch digital TV on a computer. On the Pi I installed <a href="http://www.rtl-sdr.com/adsb-aircraft-radar-with-rtl-sdr/">*Dump1090 </a>*— a program which accesses ADS-B data via the RTL2832U and a small antennae</p>
<p><img src="00000001.jpeg" alt="Raspberry Pi and a RTL2832U as a software defined radio (SDR)"><em>Raspberry Pi and a RTL2832U as a software defined radio (SDR)</em></p>
<h2 id="ads-b-signals-to-kafka-topics">ADS-B signals to Kafka Topics</h2>
<p>Now I’ve got a stream of raw ADS-B signals we need to have a look at the traffic. Kafka is a pretty awesome stream processing platform. I started by <a href="https://github.com/saubury/plane-kafka/blob/master/raspberry-pi/plane-kafka.py">separating</a> the incoming ADS-B signals into two kafka topics, location-topic (aircraft code with height and location) and callsign-topic (aircraft code and callsign).</p>
<p><img src="00000002.png" alt=""></p>
<p>I wanted to understand what the planes were and what routes they were flying. Luckily I found a <a href="https://openflights.org/data.html">database</a> of airframes (eg, ICAO code ‘7C6DB8’ is a Boeing 737). This <a href="https://github.com/saubury/plane-kafka/blob/master/scripts/02_do_load">mapping </a>I loaded into the <em>icao-to-aircraft</em> topic.</p>
<p><a href="https://www.confluent.io/product/ksql/">KSQL </a>provides a “SQL engine” that enables real-time data processing against Apache Kafka topics. That means we can query our aircraft topic like this</p>
<pre><code>create stream icao_to_aircraft_stream 
  with (KAFKA_TOPIC='icao-to-aircraft', VALUE_FORMAT='AVRO');

select manufacturer, aircraft, registration 
from icao_to_aircraft_stream 
where icao = '7C6DB8';

Boeing | B738 | VH-VYI
</code></pre>
<p>Similarly, into the <em>callsign-details</em> topic I loaded callsign details (eg, ‘QFA563’ is a Qantas flight from Brisbane to Sydney).</p>
<pre><code>create stream callsign_details_stream 
  with (KAFKA_TOPIC='callsign-details', VALUE_FORMAT='AVRO');

select operatorname, fromairport, toairport 
from callsign_details_stream 
where callsign = 'QFA563';

Qantas | Brisbane | Sydney
</code></pre>
<p>Let’s have a peek at the “location-topic” stream. You can see a steady stream of incoming messages reporting location updates from passing aircraft.</p>
<pre><code>kafka-avro-console-consumer --bootstrap-server localhost:9092 --property --topic location-topic

{&quot;ico&quot;:&quot;7C6DB8&quot;,&quot;height&quot;:&quot;6250&quot;,&quot;location&quot;:&quot;-33.807724,151.091495&quot;}
</code></pre>
<p>The equivalent KSQL syntax is</p>
<pre><code>select timestamptostring(rowtime, 'yyyy-MM-dd HH:mm:ss')
, ico
, height
, location 
from location_stream 
where ico = '7C6DB8';

2018-05-19 07:13:33 | 7C6DB8 | 6250.0 | -33.807724,151.091495
</code></pre>
<h2 id="ksql--crossing-the-streams-">KSQL — Crossing the streams …</h2>
<p>The real power of KSQL comes from combining the incoming stream of location data against the static details topics (see <a href="https://github.com/saubury/plane-kafka/blob/master/scripts/03_ksql.sql">03_ksql.sq)</a>. That is, adding useful details to the raw data stream. This is very similar to a “left join” in database language. In fact, the syntax for KSQL is indeed a left join…</p>
<pre><code>create stream location_and_details_stream as 
select l.ico
, l.height
, l.location
, t.aircraft
from location_stream l 
left join icao_to_aircraft t on l.ico = t.icao;
</code></pre>
<p>And a KSQL query the stream like this</p>
<pre><code>select timestamptostring(rowtime, 'yy-MM-dd HH:mm:ss') 
, manufacturer 
, aircraft 
, registration 
, height 
, location 
from location_and_details_stream;

18-05-27 09:53:28 | Boeing | B738 | VH-YIA | 7225 | -33.821,151.052
18-05-27 09:53:31 | Boeing | B738 | VH-YIA | 7375 | -33.819,151.049
18-05-27 09:53:32 | Boeing | B738 | VH-YIA | 7425 | -33.818,151.048
</code></pre>
<p>Equally, we can combine the incoming callsign identity stream against the static callsign_details topic</p>
<pre><code>create stream ident_callsign_stream as 
select i.ico
, c.operatorname
, c.callsign
, c.fromairport
, c.toairport 
from ident_stream i 
left join callsign_details c on i.indentification = c.callsign;

select timestamptostring(rowtime, 'yy-MM-dd HH:mm:ss') \
, operatorname \
, callsign \
, fromairport \
, toairport \
from ident_callsign_stream ;

18-05-27 13:33:19 | Qantas          | QFA926 | Sydney  | Cairns
18-05-27 13:44:11 | China Eastern   | CES777 | Kunming | Sydney
18-05-27 14:00:54 | Air New Zealand | ANZ110 | Sydney | Auckland
</code></pre>
<p>Now we have a constantly updating topic with flight details — we can make some pretty dashboards. I used <a href="https://www.confluent.io/product/connectors/">Kafka Connect</a> to pump Kafka topics into <a href="https://www.elastic.co/products/kibana">Elastic Kibana</a> (<a href="https://github.com/saubury/plane-kafka/tree/master/scripts">full scripts</a>).</p>
<h2 id="kibana-dashboard">Kibana Dashboard</h2>
<p>Here’s a sample of dashboards displaying aircraft location on a map. In addition a bar-chart of manufactures, an altitude line plot and a destination word-cloud.</p>
<p><img src="00000003.gif" alt="Kibana Display"><em>Kibana Display</em></p>
<h2 id="findings--conclusion">Findings &amp; Conclusion</h2>
<p>As best as I can remember, today my cat woke me at a little past 6am. I can use KSQL to find a low flying aircraft (below 3500ft) around this time …</p>
<pre><code>select timestamptostring(rowtime, 'yyyy-MM-dd HH:mm:ss')
, manufacturer 
, aircraft 
, registration 
, height 
from location_and_details_stream 
where height &lt; 3500
and rowtime &gt; stringtotimestamp('18-05-27 06:10', 'yy-MM-dd HH:mm') and rowtime &lt; stringtotimestamp('18-05-27 06:20', 'yy-MM-dd HH:mm');

2018-05-27 06:15:39 | Airbus | A388 | A6-EOD | 2100.0
2018-05-27 06:15:58 | Airbus | A388 | A6-EOD | 3050.0
</code></pre>
<p>Terrific, I can locate a craft over my house at 6:15 am. It’s a A380 (which is a huge plane) on a flight to Dubai that’s waking my cat. I can confirm this by reviewing the same time period in Kibana which shows a flight path directly over my house.</p>
<p><img src="00000004.png" alt="Kibana map between 6:10 and 6:20"><em>Kibana map between 6:10 and 6:20</em></p>
<h2 id="ready-to-try-it">Ready to try it?</h2>
<p>Got a similar pet problem; or just curious how Kafka and KSQL work together? You can find a combined docker setup, helper images, KSQL and Elastic setup at:-</p>
<p><a href="https://github.com/saubury/plane-kafka">https://github.com/saubury/plane-kafka</a></p>

      </article>
      
    </main>
    <nav class="end-nav side-padding">
      
    </nav>
    <footer class="side-padding" style="background-image: url('https://simonaubury.com/img/home-blob-flip.svg');">
    <a href="https://simonaubury.com/" class="footer-link">
    
        <img class="footer-icon" src="https://simonaubury.com/icons/home.svg" alt="Home">
    
    </a>
    
    
    
    <a href="https://github.com/saubury" class="footer-link" target="_blank" rel="noopener noreferrer">
    
        <img class="footer-icon" src="https://simonaubury.com/icons/github.svg" alt="GitHub"/>
    
    </a>
    
    
    
    <a href="https://www.linkedin.com/in/simonaubury" class="footer-link" target="_blank" rel="noopener noreferrer">
    
        <img class="footer-icon" src="https://simonaubury.com/icons/linkedin.svg" alt="LinkedIn"/>
    
    </a>
    
    
    <a href="https://simonaubury.com/index.xml" class="footer-link" target="_blank" rel="noopener noreferrer">
    
        <img class="footer-icon" src="https://simonaubury.com/icons/rss.svg" alt="RSS"/>
    
    </a>
    
    
    
    
    
    
    
    
</footer>
    
  <script defer src="https://simonaubury.com/js/katex.min.js"></script>


  <script defer src="https://simonaubury.com/js/auto-render.min.js" onload="renderMathInElement(document.body);"></script>


<script src="https://simonaubury.com/js/core.min.js"></script>

  </body>
</html>
