<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>1 Cat, 3 Clouds‚Ää‚Äî‚ÄäPart 1 - Where is Snowy sleeping?</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://simonaubury.com/index.xml">
		<link rel="canonical" href="https://simonaubury.com/202101_1cat3cloudspart1/post/">
		
		<link rel="shortcut icon" type="image/png" href="https://simonaubury.com/apple-touch-icon-precomposed.png">
		
		
		<meta name="generator" content="Hugo 0.68.3" />

		
		<meta property="og:title" content="1 Cat, 3 Clouds‚Ää‚Äî‚ÄäPart 1 - Where is Snowy sleeping?" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://simonaubury.com/202101_1cat3cloudspart1/00000010.png" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://simonaubury.com/202101_1cat3cloudspart1/post/" />
		<meta property="og:site_name" content="1 Cat, 3 Clouds‚Ää‚Äî‚ÄäPart 1 - Where is Snowy sleeping?" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://simonaubury.com/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://simonaubury.com/css/story.css" />
		<link rel="stylesheet" href="https://simonaubury.com/css/descartes.css" />
		
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://simonaubury.com/js/story.js"></script>

	</head>
	<body class="ma0 bg-white section-202101_1cat3cloudspart1 page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://simonaubury.com/202101_1cat3cloudspart1/00000010.png'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://simonaubury.com/" title="Home">
						<img src="https://simonaubury.com/img/logo.jpg" class="w2 h2 br-100" alt="üëã - Simon Aubury&#39;s home üè† on the Internet" />
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="https://twitter.com/simonaubury/"><i class="fab fa-twitter-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/saubury/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/simonaubury/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://simonaubury.com/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://simonaubury.com/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">1 Cat, 3 Clouds‚Ää‚Äî‚ÄäPart 1 - Where is Snowy sleeping?</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2021-01-10T12:00:00&#43;11:00">Jan 10, 2021</time>
								<span class="display-print">by </span>
								
								<span class="display-print">at https://simonaubury.com/202101_1cat3cloudspart1/post/</span>
							
						
					</h2>
				</div>

				
				
				
				

			</div>
		</header>
		
		<main role="main">
		
<article class="center bg-white br-3 pv1 ph4 lh-copy f5 nested-links mw7">
	<h1 id="1-cat-3-cloudswhere-is-snowy-sleeping">1 Cat, 3 Clouds‚Ää‚Äî‚ÄäWhere is Snowy sleeping?</h1>
<p>Our cat Snowy is an outdoor cat ‚Äî but we are beginning to wonder where she travels once she‚Äôs left the house. Let me share how I built a low cost pet tracking device to show Snowy‚Äôs location in real-time.</p>
<blockquote>
<p>Plus, what‚Äôs it like to build the same IoT data project in AWS, Azure &amp; Google Cloud in 2021? This is article 1 in a 4 part series. This first blog post describes the project and details hardware and networking components. The next three articles describe the experience of building the data pipelines with each major cloud.</p>
</blockquote>
<p><img src="/202101_1cat3cloudspart1/00000000.gif" alt="Where is Snowy?"><em>Where is Snowy?</em></p>
<p>You may already know <a href="https://simonaubury.com/201805_usingksqlapachekafkafindtheplanethatwakessnowy/post/">Snowy the cat</a>; but I‚Äôve always been curious where she goes on her day long travels. With a fascination of small ‚ÄúInternet of Things‚Äù devices and a surge of IoT announcement from the major cloud providers I was interesting in building a cat tracking project. Using some standard components could I build a real-time cat tracking solution to find Snowy‚Äôs secret sleeping area?</p>
<h2 id="goals--requirements">Goals &amp; Requirements</h2>
<p>With limited time, I wanted to ensure I was clear on the goals for the project, the hardware and software.</p>
<h3 id="project-goals">Project Goals</h3>
<ul>
<li>
<p>Real-time cat location ‚Äî so I can find her secret hiding lair and take a photo</p>
</li>
<li>
<p>Historic location ‚Äî so I can trace where she‚Äôs been over different days</p>
</li>
<li>
<p>Cool maps ‚Äî as I really like interactive dynamic maps</p>
</li>
<li>
<p>Compatible with existing cat version</p>
</li>
</ul>
<h3 id="hardware-requirements">Hardware Requirements</h3>
<ul>
<li>
<p>Pet friendly (light, waterproof, not an embarrassment in front of neighborhood cats)</p>
</li>
<li>
<p>Provide an accurate location &amp; provide a real-time up-link of location ‚Äî preferable without data costs</p>
</li>
<li>
<p>Have a long battery life and capture motion and acceleration</p>
</li>
<li>
<p>Opensource hardware a plus! Oh, and low cost ‚Äî because I‚Äôm cheap</p>
</li>
</ul>
<h3 id="software-requirements">Software Requirements</h3>
<ul>
<li>
<p>Write as little code &amp; use native cloud services where possible</p>
</li>
<li>
<p>Try each cloud to see which is the easiest (plus give me a motivation to blog a bit more about the Amazon Web Services, Microsoft Azure &amp; Google Cloud experiences)</p>
</li>
<li>
<p>Use Python (ominous foreboding; one cloud is not going to make this easy)</p>
</li>
<li>
<p>Low cost ‚Äî did I mention I‚Äôm cheap?</p>
</li>
</ul>
<h3 id="hardware-selection--communication">Hardware Selection &amp; Communication</h3>
<p>I settled on using a <a href="https://www.iot-store.com.au/collections/connected-devices/products/lorawan-gps-tracker-accelerometer-lgt92">LGT-92 GPS Tracker</a> inspired by <a href="https://www.youtube.com/watch?v=vlaxUEfHkjo">Shermayne Lee‚Äôs entertaining Internet of Dog</a> presentation. This compact device uses an onboard GPS module to determine location, and transmits these coordinates on a regular schedule.</p>
<p>What is interesting about this open-source device is data is sent (and received) via <a href="https://www.thethingsnetwork.org/docs/lorawan/architecture.html">LoRaWAN</a> ‚Äî a wireless technology designed for extremely long ranges at low data-rates. Devices communicating over a LoRaWAN network can expect up coverage of around 3km in a city to a gateway, while in the rural areas it can reach beyond 10 km.</p>
<p>The LGT-92 is pre-configured to use <a href="https://www.thethingsnetwork.org/">The Things Network</a> as the LoRaWAN network. The Things Network is a community-based worldwide LoRaWAN network which allows anyone to connect their gateways, register devices and send/receive data for <em>free</em>. That is, you can have hardware devices (such as a cat tracker) sending and receiving small data packets across a community-based network for no charge. As long as your device is less than 10km away from a <a href="https://www.thethingsnetwork.org/map">gateway</a> your data is available via secured Internet end points.</p>
<p>The module includes a low power GPS module, a 9-axis accelerometer for motion and attitude detection and a rechargeable 1000mA Li-on battery. The power for both of the GPS module (accurate to 2.5m) and accelerometer can be controlled by a motion control unit so power isn‚Äôt used if the cat is also conserving energy (eg., sleeping).</p>
<p>The TL;DR being the LGT-92 is a light-weight, power efficient location tracker ‚Äî which transmits data via a free network!</p>
<h2 id="connecting-a-cat-to-the-things-network">Connecting a cat to The Things Network</h2>
<p>Well, the first task is actually connecting the LGT-92 to The Things Network before adding the device to the cat. If the LGT-92 is attached securely to Snowy, we‚Äôll know where Snowy is when she‚Äôs outside.</p>
<p><img src="/202101_1cat3cloudspart1/00000001.png" alt=""></p>
<p>The <a href="http://www.dragino.com/downloads/downloads/LGT_92/LGT-92_LoRa_GPS_Tracker_UserManual_v1.5.5.pdf">LGT-92 User Manual</a> provides some well documented steps for how to join the device to TTN LoRaWAN Network. It is however less specific about ways to affix to your cat (I chose a pet harness)</p>
<p><img src="/202101_1cat3cloudspart1/00000002.png" alt="LGT-92 User Manual ‚Äî Connections in a LoRaWAN Network"><em>LGT-92 User Manual ‚Äî Connections in a LoRaWAN Network</em></p>
<p>The LGT-92 is shipped with a sticker with the the important default key, EUI and application keys.</p>
<p><img src="/202101_1cat3cloudspart1/00000003.png" alt="The LGT-92 with printed keys"><em>The LGT-92 with printed keys</em></p>
<p>These keys are input into The Things Network portal so the device can register itself.</p>
<p><img src="/202101_1cat3cloudspart1/00000004.png" alt="The Things Network portal"><em>The Things Network portal</em></p>
<p>Well, that‚Äôs pretty much it. Once the correct keys are entered, and the device switched on ‚Äî location updates are broadcast every five minutes when the device moves. Messages from the LGT-92 device to the The Things Network are known as <em>uplink data</em>.</p>
<p>Within The Things Network portal we can see the uplink payloads, inclusive of the Snowy‚Äôs Latitude and Longitude.</p>
<p><img src="/202101_1cat3cloudspart1/00000005.png" alt="Snowy ‚Äî we know where you are!"><em>Snowy ‚Äî we know where you are!</em></p>
<h2 id="mqtt">MQTT</h2>
<p>MQTT is a machine-to-machine ‚ÄùInternet of Things‚Äù protocol. It was designed as an extremely lightweight publish/subscribe messaging transport.</p>
<p>The Things Network uses MQTT to publish messages. That is, each location update goes onto an MQTT topic showing Snowy‚Äôs latest location.</p>
<p>I‚Äôm using <a href="https://mqttfx.jensd.de/">MQTT.fx</a> to read the messages and the <a href="https://www.thethingsnetwork.org/docs/applications/mqtt/quick-start.html">TTN MQTT quick start</a> instructions were very helpful in getting setup</p>
<p>![Connection details for MQTT.fx](/202101_1cat3cloudspart1/00000006.fx*</p>
<p>By subscribing to the <strong>+/devices/+/up</strong> MQTT topic I can see all of the LGT-92 uplink data</p>
<p><img src="/202101_1cat3cloudspart1/00000007.png" alt="Subscribing to MQTT topic"><em>Subscribing to MQTT topic</em></p>
<h3 id="uplink-data-payloads">Uplink Data Payloads</h3>
<p>The uplink message is a JSON payload from The Think Network are <a href="https://www.thethingsnetwork.org/docs/applications/mqtt/api.html">well documented</a>. I generally only care about the payload_fields as this is where the useful data from the LGT-92 including Latitude, Longitude, Battery level, Motion etc.,</p>
<p><img src="/202101_1cat3cloudspart1/00000008.png" alt="Data including location"><em>Data including location</em></p>
<p>The payload also includes some interesting metadata, including the location of the gateway (or gateways) the received the radio transmission.</p>
<p><img src="/202101_1cat3cloudspart1/00000009.png" alt=""></p>
<h2 id="sleepy-cats-and-motion-detection">Sleepy cats and motion detection</h2>
<p>To conserve power, the LGT-92 GPS Tracker will only power up the GPS and broadcast location if movement is detected. By default, the device is set to movement detect mode (AT+MD=1). In this mode, if the tracker is not moving, it will uplink location info every 1 hour. If the tracker moves, it will uplink location info at every 5 minutes.</p>
<p><img src="/202101_1cat3cloudspart1/00000010.png" alt="Snowy ‚Äî unsure of the value of this project"><em>Snowy ‚Äî unsure of the value of this project</em></p>
<p>Now, Snowy the cat sleeps* a lot. *This meant that while the cat was conserving power so too was the tracker. If Snowy wanted a long nap I may not get a location update for hours!</p>
<p>I wanted the movement mode disabled, so the location was updated every 5 minutes regardless if Snowy was moving or asleep. This does impact battery life, but this wasn‚Äôt a huge issue.</p>
<p>To change the movement detection mode of the LGT-92 I would need to send a special <em>downlink message</em> (ie., a message from the Internet to the device). By following <a href="https://www.thethingsnetwork.org/docs/applications/http/">these instructions</a> I was able to determine the downlink URL for my device</p>
<pre><code>export downlink_url=&quot;https://integrations.thethingsnetwork.org/ttn-eu/api/v2/down/saubury-001/mydownlink?key=ttn-account-v2.XXXXxxxxXXX&quot;
</code></pre>
<p>To disable the <a href="http://www.dragino.com/downloads/downloads/LGT_92/DRAGINO_LGT92_AT_Commands_v1.5.3.pdf">motion detection mode</a> I would need so send a downlink message of *AT+MD=0 *to my device. This sequence is encoded as <em><strong>0xA500</strong></em> which is <em><strong>pQA=</strong></em> in Base64. To schedule this downlink message I used this curl command</p>
<pre><code>curl -X POST --data '{&quot;dev_id&quot;: &quot;saubury0001&quot;,  &quot;payload_raw&quot;: &quot;pQA=&quot; }'  ${downlink_url}
</code></pre>
<p>This downlink message is queued and visible in The Things Network portal</p>
<p><img src="/202101_1cat3cloudspart1/00000011.png" alt="Downlink message"><em>Downlink message</em></p>
<p>With motion detection disabled on the device, Snowy‚Äôs location is now updated every 5 minutes regardless if Snowy was moving or asleep</p>
<h2 id="summary--next-steps">Summary &amp; Next Steps</h2>
<p>So far I have managed to get reliable location updates broadcast to a secure MQTT topic. These location messages are transmitted every 5 minutes.</p>
<p>But there is a lot still to do. I need to integrate these IoT messages, store them securely, process &amp; refine the messages and finally plot the paths on a map. These are fairly routine problems, so I wanted to try out each of the major cloud providers (AWS, Azure &amp; Google Cloud) to see how easy it was to build each solution.</p>
<p><img src="/202101_1cat3cloudspart1/00000012.png" alt="Example map built on AWS cloud technologies"><em>Example map built on AWS cloud technologies</em></p>
<p>The next three articles in this blog series explores building an end to end project using native cloud services. There are good aspects of each cloud platform, plus a few stumbling blocks where things do not work as expected</p>
<ul>
<li>
<p><a href="https://simonaubury.com/202102_1cat3cloudspart2/post/">Amazon Web Services ‚Äî AWS Elastic Beanstalk, AWS IoT, DynamoDB and SageMaker</a></p>
</li>
<li>
<p>Microsoft Azure ‚Äî Azure Functions, Cosmos DB and Cosmic notebooks (<strong>currently unpublished</strong>)</p>
</li>
<li>
<p>Google Cloud ‚Äî Cloud Build, Cloud Functions, BigQuery and Geo Viz (<strong>currently unpublished</strong>)</p>
</li>
</ul>
<h2 id="code-for-this-project">Code for this project</h2>
<p>Thanks for reading this far. All code for this project available at</p>
<ul>
<li><a href="https://github.com/saubury/3clouds1cat/">https://github.com/saubury/3clouds1cat/</a></li>
</ul>
<h2 id="references-and-links">References and Links</h2>
<ul>
<li>
<p>Shermayne Lee: <a href="https://www.youtube.com/watch?v=vlaxUEfHkjo">Internet of Dog</a></p>
</li>
<li>
<p><a href="https://www.thethingsnetwork.org">The Thing Network</a></p>
</li>
<li>
<p><a href="http://www.dragino.com/downloads/downloads/LGT_92/LGT-92_LoRa_GPS_Tracker_UserManual_v1.5.5.pdf">LGT-92 LoRa GPS Tracker_User Manual</a></p>
</li>
<li>
<p><a href="https://mqttfx.jensd.de/">MQTT.fx</a></p>
</li>
</ul>

</article>

		</main>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					
				
			
		
		</div>
		
	</div>

		
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://simonaubury.com/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2022 
			</p>
		</footer>
		
	
	
	</body>
</html>
